# Cartographer ROS TurtleBot3 Navigation

## インストール方法
```
sudo apt-get install ros-melodic-map-server ros-melodic-amcl ros-melodic-move-base ros-melodic-dwa-local-planner

cd ~/catkin_ws/src/
git clone https://github.com/ROBOTIS-GIT/turtlebot3_msgs.git
git clone https://github.com/ROBOTIS-GIT/turtlebot3.git
cd ~/catkin_ws && catkin_make_isolated --install --use-ninja
```


## TurtleBot3 Navigationカスタマイズ

turtlebot3は`odom`に`imu`を利用しています。Cartographer ROSは2Dの場合、imu無しで動作可能なので、turtlebot3のnavigationで利用する`map_server`をCartographer ROSに入れ替えます。<br>

## turtlebot3_navigation.launch
turtlebt3の`map_server`を`cartographer_occupancy_grid_node`に変更します。<br>
```
vi ~/catkin_ws/src/turtlebot3/turtlebot3_navigation/launch/turtlebot3_navigation.launch
```
```
--- /home/ubuntu/catkin_ws/src/turtlebot3/turtlebot3_navigation/launch/turtlebot3_navigation.launch.org	2019-04-26 05:14:02.370003860 +0000
+++ /home/ubuntu/catkin_ws/src/turtlebot3/turtlebot3_navigation/launch/turtlebot3_navigation.launch	2019-04-26 05:17:07.793640522 +0000
@@ -11,7 +11,17 @@
   </include>
 
   <!-- Map server -->
-  <node pkg="map_server" name="map_server" type="map_server" args="$(arg map_file)"/>
+  <node name="cartographer_node" pkg="cartographer_ros"
+      type="cartographer_node" args="
+          -configuration_directory $(find cartographer_ros)/configuration_files
+          -configuration_basename online_ydlidar_2d_localization.lua
+          -load_state_filename $(arg load_state_filename)"
+      output="screen">
+    <remap from="echoes" to="horizontal_laser_2d" />
+  </node>
+
+  <node name="cartographer_occupancy_grid_node" pkg="cartographer_ros"
+      type="cartographer_occupancy_grid_node" args="-resolution 0.05" />
 
   <!-- AMCL -->
   <include file="$(find turtlebot3_navigation)/launch/amcl.launch"/>
```


### parameter
デフォルトのまま
~/catkin_ws/src/turtlebot3/turtlebot3_navigation/param/costmap_common_params_burger.yaml


```
vi ~/catkin_ws/install_isolated/share/cartographer_ros/launch/nano_robot.launch
```
```
<launch>
  <arg name="set_lidar_frame_id" default="base_footprint"/>

  <include file="$(find ydlidar)/launch/lidar.launch"/>

  <node pkg="turtlebot3_bringup" type="turtlebot3_diagnostics" name="turtlebot3_diagnostics" output="screen">
    <remap from="base_footprint" to="base_scan" />
  </node>
</launch>
```

### 再ビルド
```
cd ~/catkin_ws && catkin_make_isolated --install --use-ninja
```


## 実行
on TX2
```
cd ~/github/YDLIDAR-Cartographer-ROS/scripts
./nano.sh
```

on PC
```
cd ~/github/YDLIDAR-Cartographer-ROS/scripts
./nano_rviz.sh
```

[![online localizaton](https://img.youtube.com/vi/rVEixaYxgJI/2.jpg)](https://www.youtube.com/watch?v=rVEixaYxgJI)



on TX2
```
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python get-pip.py
rm -rf get-pip.py

pip install testresources
pip install --upgrade pip
pip install --upgrade setuptools
pip install --upgrade smbus2
```

```
mkdir ~/github
cd ~/github/
git clone https://github.com/naisy/roscar
cd roscar
sudo su
python run_nanocar.py
```
