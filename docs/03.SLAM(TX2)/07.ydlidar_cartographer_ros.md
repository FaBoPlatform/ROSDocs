# YDLIDAR Cartographer ROS

[https://github.com/FaBoPlatform/YDLIDAR-Cartographer-ROS](https://github.com/FaBoPlatform/YDLIDAR-Cartographer-ROS) パラメータの作り方について<br>


[Cartographer ROSのドキュメント](https://google-cartographer-ros.readthedocs.io/en/latest/your_bag.html)を見ると、`backpack`をベースとして`.launch`ファイルと`.lua`ファイルを用意することになるようです。<br>

YDLIDAR用にbackpack_2dのファイルをコピーします。<br>

```
sudo cp /opt/ros/melodic/share/cartographer_ros/launch/backpack_2d.launch \
        /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d.launch

sudo cp /opt/ros/melodic/share/cartographer_ros/launch/demo_backpack_2d_localization.launch \
        /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d_localization.launch

sudo cp /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d_localization.launch \
        /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d_localization_only.launch

sudo cp /opt/ros/melodic/share/cartographer_ros/launch/assets_writer_backpack_2d.launch \
        /opt/ros/melodic/share/cartographer_ros/launch/assets_writer_ydlidar_2d.launch

sudo cp /opt/ros/melodic/share/cartographer_ros/launch/offline_backpack_2d.launch \
        /opt/ros/melodic/share/cartographer_ros/launch/offline_ydlidar_2d.launch

sudo cp /opt/ros/melodic/share/cartographer_ros/configuration_files/backpack_2d.lua \
        /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d.lua

sudo cp /opt/ros/melodic/share/cartographer_ros/configuration_files/backpack_2d_localization.lua \
        /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization.lua

sudo cp /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization.lua \
        /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization_only.lua

sudo cp /opt/ros/melodic/share/cartographer_ros/configuration_files/assets_writer_backpack_2d.lua \
        /opt/ros/melodic/share/cartographer_ros/configuration_files/assets_writer_ydlidar_2d.lua

sudo cp /opt/ros/melodic/share/cartographer_ros/configuration_files/assets_writer_backpack_2d_ci.lua \
        /opt/ros/melodic/share/cartographer_ros/configuration_files/assets_writer_ydlidar_2d_ci.lua

sudo cp /opt/ros/melodic/share/cartographer_ros/configuration_files/backpack_2d_localization_evaluation.lua \
        /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization_evaluation.lua

sudo cp /opt/ros/melodic/share/cartographer_ros/configuration_files/backpack_2d_server.lua \
        /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_server.lua
```

それぞれ編集していきますが、YDLIDARの計測距離は中国語で書かれた情報をもとにします。<br>

## ydlidar_2d.launch
online SLAMの時に利用します。
```
sudo vi /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d.launch
```

```
launch
--- /opt/ros/melodic/share/cartographer_ros/launch/backpack_2d.launch	2018-06-01 21:27:27.000000000 +0900
+++ /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d.launch	2019-04-18 10:45:11.633852650 +0900
@@ -24,7 +24,7 @@
   <node name="cartographer_node" pkg="cartographer_ros"
       type="cartographer_node" args="
           -configuration_directory $(find cartographer_ros)/configuration_files
-          -configuration_basename backpack_2d.lua"
+          -configuration_basename ydlidar_2d.lua"
       output="screen">
     <remap from="echoes" to="horizontal_laser_2d" />
   </node>
```

## ydlidar_2d_localization.launch
自己位置推定の時に利用します。<br>
他のPCでrvizを起動出来るようにするために、`rviz`はは削除します。<br>
リアルタイムで自己位置推定を行うために、`rosbag play`は削除します。
```
sudo vi /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d_localization.launch
```

```
--- /opt/ros/melodic/share/cartographer_ros/launch/demo_backpack_2d_localization.launch	2018-06-01 21:27:27.000000000 +0900
+++ /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d_localization.launch	2019-04-18 17:13:52.222148292 +0900
@@ -26,7 +26,7 @@
   <node name="cartographer_node" pkg="cartographer_ros"
       type="cartographer_node" args="
           -configuration_directory $(find cartographer_ros)/configuration_files
-          -configuration_basename backpack_2d_localization.lua
+          -configuration_basename ydlidar_2d_localization.lua
           -load_state_filename $(arg load_state_filename)"
       output="screen">
     <remap from="echoes" to="horizontal_laser_2d" />
@@ -35,8 +35,4 @@
   <node name="cartographer_occupancy_grid_node" pkg="cartographer_ros"
       type="cartographer_occupancy_grid_node" args="-resolution 0.05" />
 
-  <node name="rviz" pkg="rviz" type="rviz" required="true"
-      args="-d $(find cartographer_ros)/configuration_files/demo_2d.rviz" />
-  <node name="playbag" pkg="rosbag" type="play"
-      args="--clock $(arg bag_filename)" />
 </launch>
```

## ydlidar_2d_localization_only.launch
マップが完全に完成している場合、SLAMを動作させずに、自己位置推定のみの実行で処理を軽くする事が出来ます。<br>
```
sudo vi /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d_localization_only.launch
```
```
--- /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d_localization.launch	2019-04-18 17:13:52.222148292 +0900
+++ /opt/ros/melodic/share/cartographer_ros/launch/ydlidar_2d_localization_only.launch	2019-04-18 11:58:26.981743821 +0900
@@ -26,7 +26,7 @@
   <node name="cartographer_node" pkg="cartographer_ros"
       type="cartographer_node" args="
           -configuration_directory $(find cartographer_ros)/configuration_files
-          -configuration_basename ydlidar_2d_localization.lua
+          -configuration_basename ydlidar_2d_localization_only.lua
           -load_state_filename $(arg load_state_filename)"
       output="screen">
     <remap from="echoes" to="horizontal_laser_2d" />
```

## assets_writer_ydlidar_2d.launch
軌跡を出力する時に使います。<br>
```
sudo vi /opt/ros/melodic/share/cartographer_ros/launch/assets_writer_ydlidar_2d.launch
```
```
--- /opt/ros/melodic/share/cartographer_ros/launch/assets_writer_backpack_2d.launch	2018-06-01 21:27:27.000000000 +0900
+++ /opt/ros/melodic/share/cartographer_ros/launch/assets_writer_ydlidar_2d.launch	2019-04-18 14:12:12.519944597 +0900
@@ -15,7 +15,7 @@
 -->
 
 <launch>
-  <arg name="config_file" default="assets_writer_backpack_2d.lua"/>
+  <arg name="config_file" default="assets_writer_ydlidar_2d.lua"/>
   <node name="cartographer_assets_writer" pkg="cartographer_ros" required="true"
       type="cartographer_assets_writer" args="
           -configuration_directory $(find cartographer_ros)/configuration_files
```

## offline_ydlidar_2d.launch
offline SLAMは自己位置推定のためのpbstreamフォーマットのマップを作成する時に使います。<br>
```
sudo vi /opt/ros/melodic/share/cartographer_ros/launch/offline_ydlidar_2d.launch
```
```
--- /opt/ros/melodic/share/cartographer_ros/launch/offline_backpack_2d.launch	2018-06-01 21:27:27.000000000 +0900
+++ /opt/ros/melodic/share/cartographer_ros/launch/offline_ydlidar_2d.launch	2019-04-18 16:28:06.797046959 +0900
@@ -19,9 +19,6 @@
   <param name="/use_sim_time" value="true" />
 
   <group unless="$(arg no_rviz)">
-    <node name="rviz" pkg="rviz" type="rviz" required="true"
-        args="-d $(find cartographer_ros)/configuration_files/demo_2d.rviz" />
-
     <node name="cartographer_occupancy_grid_node" pkg="cartographer_ros"
         type="cartographer_occupancy_grid_node" args="-resolution 0.05" />
   </group>
@@ -30,7 +27,7 @@
       required="$(arg no_rviz)"
       type="cartographer_offline_node" args="
           -configuration_directory $(find cartographer_ros)/configuration_files
-          -configuration_basenames backpack_2d.lua
+          -configuration_basenames ydlidar_2d.lua
           -urdf_filenames $(find cartographer_ros)/urdf/backpack_2d.urdf
           -bag_filenames $(arg bag_filenames)"
       output="screen">
```

## ydlidar_2d_rviz.launch
rvizを起動する時に使います。<br>
```
<launch>
  <param name="/use_sim_time" value="true" />

  <node 
    name="rviz" 
    pkg="rviz" 
    type="rviz" 
    required="true"
    args="-d $(find cartographer_ros)/configuration_files/demo_2d.rviz">
  </node>

</launch>
```



## ydlidar_2d.lua
online SLAMの時に使います。<br>
`tracking_frame`とpublished_frame`はYDLIDARドライバー側のlaunch設定と同じにします。<br>
他の値は中国語の情報をもとに設定します。<br>
```
sudo vi /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d.lua
```

```
--- /opt/ros/melodic/share/cartographer_ros/configuration_files/backpack_2d.lua2018-06-01 21:27:27.000000000 +0900
+++ /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d.lua	2019-04-18 12:38:36.510971973 +0900
@@ -19,17 +19,17 @@
   map_builder = MAP_BUILDER,
   trajectory_builder = TRAJECTORY_BUILDER,
   map_frame = "map",
-  tracking_frame = "base_link",
-  published_frame = "base_link",
+  tracking_frame = "laser_frame",
+  published_frame = "laser_frame",
   odom_frame = "odom",
   provide_odom_frame = true,
   publish_frame_projected_to_2d = false,
   use_odometry = false,
   use_nav_sat = false,
   use_landmarks = false,
-  num_laser_scans = 0,
-  num_multi_echo_laser_scans = 1,
-  num_subdivisions_per_laser_scan = 10,
+  num_laser_scans = 1,
+  num_multi_echo_laser_scans = 0,
+  num_subdivisions_per_laser_scan = 1,
   num_point_clouds = 0,
   lookup_transform_timeout_sec = 0.2,
   submap_publish_period_sec = 0.3,
@@ -43,6 +43,18 @@
 }
 
 MAP_BUILDER.use_trajectory_builder_2d = true
-TRAJECTORY_BUILDER_2D.num_accumulated_range_data = 10
+TRAJECTORY_BUILDER_2D.submaps.num_range_data = 35
+TRAJECTORY_BUILDER_2D.min_range = 0.08
+TRAJECTORY_BUILDER_2D.max_range = 16.
+TRAJECTORY_BUILDER_2D.missing_data_ray_length = 1.
+TRAJECTORY_BUILDER_2D.use_imu_data = false
+TRAJECTORY_BUILDER_2D.use_online_correlative_scan_matching = true
+TRAJECTORY_BUILDER_2D.real_time_correlative_scan_matcher.linear_search_window = 0.1
+TRAJECTORY_BUILDER_2D.real_time_correlative_scan_matcher.translation_delta_cost_weight = 10.
+TRAJECTORY_BUILDER_2D.real_time_correlative_scan_matcher.rotation_delta_cost_weight = 1e-1
+
+POSE_GRAPH.optimization_problem.huber_scale = 1e2
+POSE_GRAPH.optimize_every_n_nodes = 35
+POSE_GRAPH.constraint_builder.min_score = 0.65
 
 return options
```

## ydlidar_2d_localization.lua
自己位置推定の時に使います。<br>
```
sudo vi /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization.lua
```
```
--- /opt/ros/melodic/share/cartographer_ros/configuration_files/backpack_2d_localization.lua	2018-06-01 21:27:27.000000000 +0900
+++ /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization.lua	2019-04-18 11:21:39.245829761 +0900
@@ -12,7 +12,7 @@
 -- See the License for the specific language governing permissions and
 -- limitations under the License.
 
-include "backpack_2d.lua"
+include "ydlidar_2d.lua"
 
 TRAJECTORY_BUILDER.pure_localization = true
 POSE_GRAPH.optimize_every_n_nodes = 20
```


## ydlidar_2d_localization_only.lua
SLAMを動作させずに自己位置推定だけを動作させる時に使います。<br>
Cartographer ROSのドキュメントを見て変更していますが、今はまだ問題があって機能していません。<br>
```
sudo vi /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization_only.lua
```

```
--- /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization.lua	2019-04-18 11:21:39.245829761 +0900
+++ /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization_only.lua	2019-04-18 11:25:45.757409678 +0900
@@ -15,6 +15,9 @@
 include "ydlidar_2d.lua"
 
 TRAJECTORY_BUILDER.pure_localization = true
+TRAJECTORY_BUILDER.pure_localization_trimmer = {
+    max_submaps_to_keep = 3,
+}
 POSE_GRAPH.optimize_every_n_nodes = 20
 
 return options
```

## assets_writer_ydlidar_2d.lua
軌跡を出力する時に使います。<br>
`tracking_frame`はYDLIDARドライバー側の設定と同じにします。<br>
計測距離は中国語の情報にもとづいて設定します。<br>
```
sudo vi /opt/ros/melodic/share/cartographer_ros/configuration_files/assets_writer_ydlidar_2d.lua
```
```
--- /opt/ros/melodic/share/cartographer_ros/configuration_files/assets_writer_backpack_2d.lua	2018-06-01 21:27:27.000000000 +0900
+++ /opt/ros/melodic/share/cartographer_ros/configuration_files/assets_writer_ydlidar_2d.lua	2019-04-18 16:39:53.198405055 +0900
@@ -22,12 +22,12 @@
 include "transform.lua"
 
 options = {
-  tracking_frame = "base_link",
+  tracking_frame = "laser_frame",
   pipeline = {
     {
       action = "min_max_range_filter",
-      min_range = 1.,
-      max_range = 60.,
+      min_range = 0.08,
+      max_range = 16.,
     },
     {
       action = "dump_num_points",
```

## assets_writer_ydlidar_2d_ci.lua
`assets_writer_ydlidar_2d.lua`と設定方針は同じです。<br>
```
sudo vi /opt/ros/melodic/share/cartographer_ros/configuration_files/assets_writer_ydlidar_2d_ci.lua
```
```
--- /opt/ros/melodic/share/cartographer_ros/configuration_files/assets_writer_backpack_2d_ci.lua	2018-06-01 21:27:27.000000000 +0900
+++ /opt/ros/melodic/share/cartographer_ros/configuration_files/assets_writer_ydlidar_2d_ci.lua	2019-04-18 16:38:39.646331066 +0900
@@ -22,12 +22,12 @@
 include "transform.lua"
 
 options = {
-  tracking_frame = "base_link",
+  tracking_frame = "laser_frame",
   pipeline = {
     {
       action = "min_max_range_filter",
-      min_range = 1.,
-      max_range = 60.,
+      min_range = 0.08,
+      max_range = 15.,
     },
     {
       action = "dump_num_points",
```


## ydlidar_2d_localization_evaluation.lua
自己位置推定の時に使うようです。<br>
```
sudo vi /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization_evaluation.lua
```

```
--- /opt/ros/melodic/share/cartographer_ros/configuration_files/backpack_2d_localization_evaluation.lua	2018-06-01 21:27:27.000000000 +0900
+++ /opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_localization_evaluation.lua	2019-04-18 11:44:36.647488588 +0900
@@ -12,7 +12,7 @@
 -- See the License for the specific language governing permissions and
 -- limitations under the License.
 
-include "backpack_2d_localization.lua"
+include "ydlidar_2d_localization.lua"
 
 -- output map to base_link for evaluation
 options.provide_odom_frame = false
```


## ydlidar_2d_server.lua
変更なし
```
/opt/ros/melodic/share/cartographer_ros/configuration_files/ydlidar_2d_server.lua
```

```
include "map_builder_server.lua"

MAP_BUILDER_SERVER.map_builder.use_trajectory_builder_2d = true

return MAP_BUILDER_SERVER
```

## 参考
* [https://google-cartographer-ros.readthedocs.io/en/latest/your_bag.html](https://google-cartographer-ros.readthedocs.io/en/latest/your_bag.html)
* [https://www.mindthink.me/2018/11/01/cartographer%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BA%8C%EF%BC%9A-%E4%BD%BF%E7%94%A8-eai-ydlidar-%E5%AE%9E%E7%8E%B0-cartographer-2d-slam/](https://www.mindthink.me/2018/11/01/cartographer%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BA%8C%EF%BC%9A-%E4%BD%BF%E7%94%A8-eai-ydlidar-%E5%AE%9E%E7%8E%B0-cartographer-2d-slam/)
* [https://www.ncnynl.com/archives/201811/2789.html](https://www.ncnynl.com/archives/201811/2789.html)
* [https://translate.google.co.jp/translate?hl=en&sl=zh-CN&u=https://www.academia.edu/38171833/EAI_cartographer&prev=search](https://translate.google.co.jp/translate?hl=en&sl=zh-CN&u=https://www.academia.edu/38171833/EAI_cartographer&prev=search)