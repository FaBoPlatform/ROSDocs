# Offline SLAM

オフラインSLAMは、事前に保存してあるrosbagを使ってマップを作成します。<br>
マップをpbstream形式で保存できるため、マップを読み込んで自己位置推定をすることが出来るようになります。<br>

## rosbagに記録開始
YDLIDARのトピックをrosbagに記録します。<br>
```
cd ~/github/YDLIDAR-Cartographer-ROS/scripts
./04.ydlidar_rosbag_record.sh myroom.bag
```
`myroom.bag`が作成されます。


## 走行
記録しながら室内を移動します。<br>
![](./img/rccar.jpg)<br>
室内を一周したら、`Ctrol + c`で記録を終了します。<br>

## pbstream保存
rosbagファイルを使って2Dマップを作成します。<br>
```
./offline_slam.sh myroom.bag
```
`myroom.bag.pbstream`が作成されます。

## 説明
### 04.ydlidar_rosbag_record.sh
引数に出力ファイル名を指定します。<br>
```
./04.ydlidar_rosbag_record.sh output.bag
```

```
# usage:
# ./ydlidar_rosbag_record.sh output.bag

source ${HOME}/catkin_ws/devel/setup.bash

case $1 in
    /*\.bag)
        OUTPUT_BAG=$1
        ;;
    *.bag)
        OUTPUT_BAG=$PWD/$1
esac
echo ${OUTPUT_BAG}

```

roscoreを起動
```
roscore &
sleep 5 # wait until roscore launch
```
YDLIDARを起動
```
roslaunch ydlidar lidar.launch &
sleep 15 # wait until ydlidar launch
```
`-a`オプションでトピック全てをファイルに保存
```
rosrun rosbag record -a -O $OUTPUT_BAG
```

### 05.offline_slam.sh
引数に入力rosbagファイル名を指定します。<br>
```
./05.offline_slam.sh input.bag
```

```
# usage:
# ./offline_slam.sh input.bag

#https://www.ncnynl.com/archives/201811/2789.html

case $1 in
    /*\.bag)
        INPUT_BAG=$1
        ;;
    *.bag)
        INPUT_BAG=$PWD/$1
esac
echo ${INPUT_BAG}
```

cartographer-rosを利用するのでbashを読み込んでおきます。
```
source /home/ubuntu/catkin_ws/install_isolated/setup.bash
```

roscore起動
```
roscore &
sleep 5 # wait until roscore launch
```
offline SLAM起動
```
roslaunch cartographer_ros offline_ydlidar_2d.launch bag_filenames:=${INPUT_BAG}
```
pbstream保存
```
rosservice call /write_state ${INPUT_BAG}.pbstream
```
pbstreamを作成する場合は、rosbagファイルが必要になります。<br>
そのため、online SLAMからは作成することが出来ません。<br>