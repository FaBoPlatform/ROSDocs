# Offline SLAM

オフラインSLAMは、事前に保存してあるrosbagを使ってマップを作成します。<br>
マップをpbstream形式で保存できるため、マップを読み込んで自己位置推定をすることが出来るようになります。<br>

## 動画
[![offline slam](https://img.youtube.com/vi/kj3nSfnAl5s/2.jpg)](https://www.youtube.com/watch?v=kj3nSfnAl5s)


## rosbagに記録開始
`./01.online_slam.sh myroom.bag`で`myroom.bag`を作成済みの場合は不要です。<br>

YDLIDARのトピックをrosbagに記録します。<br>
```
cd ~/github/YDLIDAR-Cartographer-ROS/scripts
./05.online_record.sh myroom.bag
```
`myroom.bag`が作成されます。<br>
`./01.online_slam.sh myroom.bag`との違いとして、これはYDLIDARの値だけを保存しているので、ファイルサイズが小さくなります。<br>

## 走行
記録しながら室内を移動します。<br>
![](./img/rccar.jpg)<br>
室内を一周したら、`Ctrol + c`で記録を終了します。<br>
自己位置推定は旋回に弱いので、出来るだけゆっくり走行します。（0.5km/h程度）

## pbstream保存
rosbagファイルを使って2Dマップを作成します。<br>
TX2で実行します。<br>
```
./06.offline_slam.sh myroom.bag
```
`myroom.bag.pbstream`が作成されます。

## RViz
マップ作成状況を表示します。<br>
PCで実行します。<br>
offline SLAMは計算速度が速ければリアルタイムよりも速く処理が終わります。<br>
```
./08.offline_rviz.sh
```

## 軌跡
走行軌跡を画像に出力することが出来ます。<br>
第一引数のrosbagファイルは走行を保存したbagファイルを指定します。今回はマップ作成用に走行した`myroom.bag`を指定しています。<br>
第二引数のpbstreamファイルはマップデータの`myroom.bag.pbstream`ファイルを指定します。<br>
`myroom.bag_points.ply`と`myroom.bag_*.png`ファイルが作成されます。<br>
```
./07.offline_trajectory.sh myroom.bag myroom.bag.pbstream
```

![](img/myroom.bag_xray_xy_all.png)


## 説明
### 05.online_record.sh
YDLIDAR X4のセンサー値をrosbagに保存します。<br>
引数に出力ファイル名を指定します。<br>
```
./05.online_record.sh output.bag
```

```
# usage:
# ./05.online_record.sh output.bag

source ${HOME}/catkin_ws/devel/setup.bash

case $1 in
    /*\.bag)
        OUTPUT_BAG=$1
        ;;
    *.bag)
        OUTPUT_BAG=$PWD/$1
esac
echo ${OUTPUT_BAG}

```

roscoreを起動
```
roscore &
sleep 5 # wait until roscore launch
```
YDLIDARを起動
```
roslaunch ydlidar lidar.launch &
sleep 15 # wait until ydlidar launch
```
`-a`オプションでトピック全てをファイルに保存
```
rosrun rosbag record -a -O $OUTPUT_BAG
```
走行後に`Ctrl + c`で終了します。


### 06.offline_slam.sh
Localizationで利用するpbstream形式のマップを作成します。<br>
引数に入力rosbagファイル名を指定します。<br>
```
./06.offline_slam.sh input.bag
```

```
# usage:
# ./06.offline_slam.sh input.bag

#https://www.ncnynl.com/archives/201811/2789.html

case $1 in
    /*\.bag)
        INPUT_BAG=$1
        ;;
    *.bag)
        INPUT_BAG=$PWD/$1
esac
echo ${INPUT_BAG}
```

cartographer-rosを利用するのでbashを読み込んでおきます。
```
export ROS_MASTER_URI=http://自分(tx2)のIP:11311
export ROS_IP=自分(tx2)のIP
source /home/ubuntu/catkin_ws/install_isolated/setup.bash
```

roscore起動
```
roscore &
sleep 5 # wait until roscore launch
```
offline SLAM起動
```
roslaunch cartographer_ros offline_ydlidar_2d_slam.launch bag_filenames:=${INPUT_BAG}
```
pbstream保存
```
rosservice call /write_state ${INPUT_BAG}.pbstream
```
pbstreamを作成する場合は、rosbagファイルが必要になります。<br>
そのため、online SLAMでpbstreamを作成することは出来ません。<br>

## 07.offline_trajectory.sh
マップとなるpbstreamファイルと、そのマップ内を走行して保存したrosbagの走行軌跡を出力します。<br>
`input.bag`は走行を保存したrosbagファイルです。<br>
`myroom.bag.pbstream`はマップのpbstreamファイルです。<br>
```
./07.offline_trajectory.sh input.bag myroom.bag.pbstream
```

第一引数にbagファイル、第二引数にpbstreamファイルを指定します。<br>
```
# usage:
# ./07.offline_trajectory.sh input.bag input.bag.pbstream

case $1 in
    /*\.bag)
        INPUT_BAG=$1
        ;;
    *.bag)
        INPUT_BAG=$PWD/$1
esac
echo ${INPUT_BAG}

case $2 in
    /*\.pbstream)
        INPUT_PB=$2
        ;;
    *.pbstream)
        INPUT_PB=$PWD/$2
esac
echo ${INPUT_PB}
```
起動時の環境変数
```
export ROS_MASTER_URI=http://192.168.0.48:11311
export ROS_IP=192.168.0.48
source /home/ubuntu/catkin_ws/install_isolated/setup.bash

```
roscore起動
```
roscore &
sleep 5 # wait until roscore launch
```
軌跡を出力
```
roslaunch cartographer_ros offline_ydlidar_2d_assets_writer.launch \
    bag_filenames:=${INPUT_BAG} \
    pose_graph_filename:=${INPUT_PB}
```