# YLiDARとCartographer連携

## YDLiDAR (Jetson nano側)

~/catkin_ws/src/ydlidar/launch/lidar.launch
```xml hl_lines="4 5"
<launch>
    <node name="ydlidar_node"  pkg="ydlidar"  type="ydlidar_node" output="screen">
        <param name="port"         type="string" value="/dev/ydlidar"/>  
        <param name="baudrate"     type="int"    value="128000"/>
        <param name="frame_id"     type="string" value="laser"/> 
        <param name="angle_fixed"  type="bool"   value="true"/>
        <param name="low_exposure"  type="bool"   value="false"/>
        <param name="heartbeat"    type="bool"   value="false"/>
        <param name="resolution_fixed"    type="bool"   value="true"/>
        <param name="angle_min"    type="double" value="-180" />
        <param name="angle_max"    type="double" value="180" />
        <param name="range_min"    type="double" value="0.08" />
        <param name="range_max"    type="double" value="16.0" />
        <param name="ignore_array" type="string" value="" />
        <param name="samp_rate"    type="int"    value="9"/>
        <param name="frequency"    type="double" value="15"/>
    </node>
    <node 
        pkg="tf" 
        type="static_transform_publisher" 
        name="base_to_laser" 
        args="0.0 0.0 0.18 0 0.0 0.0 base_link laser 100">
    </node>
</launch>
```

## Cartographer (Jetson nano側)

~/catkin_ws/src/cartographer_ros/cartographer_ros/launch/demo_revo_lds.launch
```xml
<launch>
  <param name="/use_sim_time" value="true" />

  <node name="cartographer_node" pkg="cartographer_ros"
    type="cartographer_node" 
    args=" -configuration_directory $(find cartographer_ros)/configuration_files -configuration_basename revo_lds.lua"
    output="screen">
  </node>

  <node
      name="robot_state_publisher"
      pkg="robot_state_publisher"
      type="robot_state_publisher"
  />
  
  <node 
    name="cartographer_occupancy_grid_node" 
    pkg="cartographer_ros"
    type="cartographer_occupancy_grid_node" 
    args="-resolution 0.05">
  </node>

</launch>
```

~/catkin_ws/src/cartographer_ros/cartographer_ros/configuration_files/revo_lds.lua
```cpp hl_lines="8 9 12 13 14 27"
include "map_builder.lua"
include "trajectory_builder.lua"

options = {
  map_builder = MAP_BUILDER,
  trajectory_builder = TRAJECTORY_BUILDER,
  map_frame = "map",
  tracking_frame = "laser",
  published_frame = "laser",
  odom_frame = "odom",
  provide_odom_frame = false,
  use_odometry = false,
  publish_frame_projected_to_2d = false,
  use_nav_sat = false,
  use_landmarks = false,
  num_laser_scans = 1,
  num_multi_echo_laser_scans = 0,
  num_subdivisions_per_laser_scan = 1,
  num_point_clouds = 0,
  lookup_transform_timeout_sec = 0.2,
  submap_publish_period_sec = 0.3,
  pose_publish_period_sec = 5e-3,
  trajectory_publish_period_sec = 30e-3,
  rangefinder_sampling_ratio = 1.,
  odometry_sampling_ratio = 1.,
  imu_sampling_ratio = 1.,
  landmarks_sampling_ratio = 1.,
  fixed_frame_pose_sampling_ratio = 1.,
}

MAP_BUILDER.use_trajectory_builder_2d = true

TRAJECTORY_BUILDER_2D.submaps.num_range_data = 35
TRAJECTORY_BUILDER_2D.min_range = 0.08
TRAJECTORY_BUILDER_2D.max_range = 16.
TRAJECTORY_BUILDER_2D.missing_data_ray_length = 1.
TRAJECTORY_BUILDER_2D.use_imu_data = false
TRAJECTORY_BUILDER_2D.use_online_correlative_scan_matching = true
TRAJECTORY_BUILDER_2D.real_time_correlative_scan_matcher.linear_search_window = 0.1
TRAJECTORY_BUILDER_2D.real_time_correlative_scan_matcher.translation_delta_cost_weight = 10.
TRAJECTORY_BUILDER_2D.real_time_correlative_scan_matcher.rotation_delta_cost_weight = 1e-1

POSE_GRAPH.optimization_problem.huber_scale = 1e2
POSE_GRAPH.optimize_every_n_nodes = 35
POSE_GRAPH.constraint_builder.min_score = 0.65

return options
```

起動用
~/catkin_ws/src/cartographer_ros/cartographer_ros/launch/demo_rviz.launch
```xml
<launch>
  <param name="/use_sim_time" value="true" />

  <node 
    name="rviz" 
    pkg="rviz" 
    type="rviz" 
    required="true"
    args="-d $(find cartographer_ros)/configuration_files/demo_2d.rviz">
  </node>

</launch>
```

Build
```
$ cd ~/catkin_ws
$ catkin_make_isolated --install --use-ninja
$ source install_isolated/setup.bash
```

環境変数の設定
```
$ export ROS_MASTER_URI=http://自分のIP:11311
```

起動
```
$ roscore 
$ roslaunch ydlidar lidar.launch
$ roslaunch cartographer_ros demo_revo_lds.launch
$ roslaunch cartographer_ros demo_rviz.launch
```

## グラフ

グラフを表示
```
$ rosrun rqt_graph rqt_graph
```

## 他のPCからの接続

環境編数
```
$ export ROS_MASTER_URI=http://roscoreを起動しているマシンのIP:11311
$ export ROS_ID=自分のIP
```
rvizを起動
```
$ roslaunch cartographer_ros demo_rviz.launch
```

## 参考

* [https://www.youtube.com/watch?v=4ipDP9dIYYs](https://www.youtube.com/watch?v=4ipDP9dIYYs)
* [https://qiita.com/PINTO/items/4845c438cac05eda4d1e](https://qiita.com/PINTO/items/4845c438cac05eda4d1e)
* [https://www.mindthink.me/2018/11/01/cartographer%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BA%8C%EF%BC%9A-%E4%BD%BF%E7%94%A8-eai-ydlidar-%E5%AE%9E%E7%8E%B0-cartographer-2d-slam/](https://www.mindthink.me/2018/11/01/cartographer%E5%AD%A6%E4%B9%A0%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BA%8C%EF%BC%9A-%E4%BD%BF%E7%94%A8-eai-ydlidar-%E5%AE%9E%E7%8E%B0-cartographer-2d-slam/)

