# TX2にYDLIDAR X4


## Download
```
cd ~/catkin_ws/src
git clone https://github.com/EAIBOT/ydlidar.git
cd ..
```

## Edit
`scan_msg.scan_time`と`scan_msg.time_increment`のフォーマットに問題があるようなので、YDLIDARのIssues [https://github.com/EAIBOT/ydlidar/issues/14](https://github.com/EAIBOT/ydlidar/issues/14) にあがっている修正を実施する。

### ydlidar_node.cpp
```
vi ~/catkin_ws/src/ydlidar/src/ydlidar_node.cpp
```
diffコマンドの結果:<br>
```
diff -u ~/catkin_ws/src/ydlidar/src/ydlidar_node.cpp.org ~/catkin_ws/src/ydlidar/src/ydlidar_node.cpp
--- /home/ubuntu/catkin_ws/src/ydlidar/src/ydlidar_node.cpp.org	2019-04-17 11:52:17.775006029 +0900
+++ /home/ubuntu/catkin_ws/src/ydlidar/src/ydlidar_node.cpp	2019-04-17 11:52:32.206993273 +0900
@@ -131,8 +131,8 @@
             scan_msg.angle_min = scan.config.min_angle;
             scan_msg.angle_max = scan.config.max_angle;
             scan_msg.angle_increment = scan.config.ang_increment;
-            scan_msg.scan_time = scan.config.scan_time;
-            scan_msg.time_increment = scan.config.time_increment;
+            scan_msg.scan_time = scan.config.scan_time/1000000000.0;
+            scan_msg.time_increment = scan.config.time_increment/1000000000.0;
             scan_msg.range_min = scan.config.min_range;
             scan_msg.range_max = scan.config.max_range;
```

### lidar.launch
YDLIDAR X4データシートには以下のように記載されています。<br>

| Item | Min. | Typical Value | Max. | Unit | Remark |
|--:|--:|--:|--:|--:|--:|
| Range Frequency | - | 5000 | - | Hz | 5000 range sampling per second |
| Scanning Frequency | 6 | - | 12 | Hz | Configurable by software |
| Range | 0.12 | - | >10 | m | Indoor |
| Scanning Angle | - | 0-360 | - | Deg | - |
| Range resolution | - | <0.5 | - | mm | Range<2m |
| Range resolution | - | <1% of actual distance | - | mm | Range>2m |
| Angle resolution | 0.48 | 0.50 | 0.52 | Deg | Scanning Frequency 7Hz|
| Working life | - | 1500 | - | h | Continuous working life |
| Supply voltage | 4.8 | 5 | 5.2 | V | Excessive voltage can damage the device. Low voltage can affect performance. |
| Voltage ripple | 0 | 50 | 100 | mV | High ripple affects performance and can even cause Lidar to fail to range |
| Starting current | 400 | 450 | 480 | mA | High current startup |
| Working current | 330 | 350 | 380 | mA | System work, motor rotates |
| Baud rate | - | 128000 | - | bps | 8 data bits, 1 stop bit, no parity |
| Signal high | 1.8 | 3.3 | 3.5 | V | When the signal voltage is >1.8V, it is high level |
| Signal low | 0 | 0 | 0.5 | V | When the signal voltage is <0.5V, it is low level |
| PWM frequency | - | 10 | - | KHz | PWM is a square wave signal |
| Duty cycle range | 50% | 85% | 100% | The shorter the duty cycle, the faster the speed |
| Laser wavelength | 775 | 785 | 795 | nm | Infrared band |
| Laser power | - | 3 | 5 | mW |
| Working temperature | 0 | 20 | 40 | ℃ | Long-term work in high temperature environment will reduce the working life |
| Lighing environment | 0 | 550 | 2200 | Lux | For reference only |
| N.W. | - | 180 | - | g | - |

この値に基づいて、`lidar.launch`ファイルを編集します。<br>

| パラメータ | 値 | 考察 |
|--:|--:|--:|
| baudrate | 12800 | 単位はbps。データシートのBaud rateから。 |
| range_min | 0.12 | 単位はm。データシートのRangeから。 |
| range_max | 10.0 | 単位はm。データシートのRangeでは>10となっているが、正確な最大値が分からないので10.0としておく。 |
| samp_rate | 4 | 単位はK。データシートのRange Frequencyでは5000となっているが、ドライバーに5Kは無く、4K,8K,9K,10Kから選択する。 |
| frequency | 7 | 単位はHz。データシートのScanning Frequencyから。 |

ノードタイプ`static_transform_publisher`の`x` `y` `z` `yaw` `pitch` `roll` `frame_id` `child_frame_id` `period_in_ms`について、<br>
`x` `y` `z` `yaw` `pitch` `roll`はYDLIDAR X4の取り付け位置に関する設定で、全て`0`にします。<br>
`period_in_ms`はpublishする周期をミリセカンドで指定します。ROSでは100ms(10Hz)がよい値とされています。<br>

その他のパラメータについては、<br>
[https://github.com/EAIBOT/ydlidar](https://github.com/EAIBOT/ydlidar)ここを参考にしてください。<br>

```
vi ~/catkin_ws/src/ydlidar/launch/lidar.launch
```
```
--- /home/ubuntu/catkin_ws/src/ydlidar/launch/lidar.launch.org	2019-04-23 12:03:31.620454277 +0900
+++ /home/ubuntu/catkin_ws/src/ydlidar/launch/lidar.launch	2019-04-23 12:04:30.700394990 +0900
@@ -1,7 +1,7 @@
 <launch>
   <node name="ydlidar_node"  pkg="ydlidar"  type="ydlidar_node" output="screen" respawn="false" >
     <param name="port"         type="string" value="/dev/ydlidar"/>  
-    <param name="baudrate"     type="int"    value="115200"/>
+    <param name="baudrate"     type="int"    value="128000"/>
     <param name="frame_id"     type="string" value="laser_frame"/>
     <param name="low_exposure"  type="bool"   value="false"/>
     <param name="resolution_fixed"    type="bool"   value="true"/>
@@ -9,12 +9,12 @@
     <param name="reversion"    type="bool"   value="false"/>
     <param name="angle_min"    type="double" value="-180" />
     <param name="angle_max"    type="double" value="180" />
-    <param name="range_min"    type="double" value="0.1" />
-    <param name="range_max"    type="double" value="16.0" />
+    <param name="range_min"    type="double" value="0.12" />
+    <param name="range_max"    type="double" value="10.0" />
     <param name="ignore_array" type="string" value="" />
-    <param name="samp_rate"    type="int"    value="9"/>
+    <param name="samp_rate"    type="int"    value="4"/>
     <param name="frequency"    type="double" value="7"/>
   </node>
-  <node pkg="tf" type="static_transform_publisher" name="base_link_to_laser4"
-    args="0.2245 0.0 0.2 0.0 0.0  0.0 /base_footprint /laser_frame 40" />
+  <node pkg="tf" type="static_transform_publisher" name="base_link_to_laser"
+    args="0.0 0.0 0.0 0.0 0.0  0.0 /base_link /laser_frame 100" />
 </launch>
```

## Build
```
cd ~/catkin_ws
catkin_make_isolated --install --use-ninja
```

## Add device configration

```
sudo ~/catkin_ws/src/ydlidar/startup/initenv.sh
```

## Install YDLIDAR Cartographer-ROS
Cartographerで使えるようにするためのパラメータファイルをインストールします。<br>
```
mkdir ~/github
cd ~/github
git clone https://github.com/FaBoPlatform/YDLIDAR-Cartographer-ROS

cd YDLIDAR-Cartographer-ROS/parameters/
sudo cp *.launch /opt/ros/melodic/share/cartographer_ros/launch/
sudo cp *.lua /opt/ros/melodic/share/cartographer_ros/configuration_files/
```

## Reference
YDLIDAR X4 データシート：[http://www.ydlidar.com/download](http://www.ydlidar.com/download)<br>
YDLIDAR X4 ドライバードキュメント：~/catkin_ws/src/ydlidar/sdk/doc/html/classydlidar_1_1_y_dlidar_driver.html<br>
static_transform_publisher：[http://wiki.ros.org/tf#static_transform_publisher](http://wiki.ros.org/tf#static_transform_publisher)<br>